<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="modoo.module.shop.stats.cstmr.service.impl.StatsCstmrMapper">

	<!-- 고객 요일별 분석목록 -->
	<select id="selectStatsCstmrWeekList" parameterType="modoo.module.shop.stats.cstmr.service.StatsCstmrSearchVO" resultType="egovMap">
		SELECT 
			CASE WEEKDAY(STR_TO_DATE(DE, '%Y%m%d'))
					WHEN '0' THEN '월'
					WHEN '1' THEN '화'
					WHEN '2' THEN '수'
					WHEN '3' THEN '목'
					WHEN '4' THEN '금'
					WHEN '5' THEN '토'
					WHEN '6' THEN '일'
					END WD_NM
			,SUM(LOGIN_CNT) LOGIN_CNT
			,SUM(SBSCRB_CNT) SBSCRB_CNT
			,SUM(GOODS_CNT) GOODS_CNT
			,SUM(SETLE_STOT_AMOUNT) SETLE_STOT_AMOUNT
		FROM (
			SELECT 
				DE 
				,WEEKDAY(STR_TO_DATE(DE, '%Y%m%d')) WD
				,IFNULL(LOGIN_CNT,0) LOGIN_CNT
				,IFNULL(SBSCRB_CNT,0) SBSCRB_CNT
				,IFNULL(t4.GOODS_CNT,0) GOODS_CNT
				,IFNULL(t4.SETLE_STOT_AMOUNT,0) SETLE_STOT_AMOUNT
			FROM (
					SELECT
						DATE_FORMAT(GEN_DATE, '%Y%m%d') DE
					FROM (SELECT ADDDATE('1970-01-01',T4*10000 + T3*1000 + T2*100 + T1*10 + T0) GEN_DATE FROM
									 (SELECT 0 T0 UNION SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5 UNION SELECT 6 UNION SELECT 7 UNION SELECT 8 UNION SELECT 9) T0,
									 (SELECT 0 T1 UNION SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5 UNION SELECT 6 UNION SELECT 7 UNION SELECT 8 UNION SELECT 9) T1,
									 (SELECT 0 T2 UNION SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5 UNION SELECT 6 UNION SELECT 7 UNION SELECT 8 UNION SELECT 9) T2,
									 (SELECT 0 T3 UNION SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5 UNION SELECT 6 UNION SELECT 7 UNION SELECT 8 UNION SELECT 9) T3,
									 (SELECT 0 T4 UNION SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5 UNION SELECT 6 UNION SELECT 7 UNION SELECT 8 UNION SELECT 9) T4
					) V
					WHERE GEN_DATE BETWEEN STR_TO_DATE(CONCAT(#{searchBgnde},'000000'), '%Y%m%d%H%i%s') AND STR_TO_DATE(CONCAT(#{searchEndde},'235959'), '%Y%m%d%H%i%s')
				) t1 
				LEFT JOIN (
					 SELECT 
						DATE_FORMAT(ll.CREAT_DT, '%Y%m%d') LOGIN_DE
						,COUNT(*) LOGIN_CNT
					FROM DTH_LOGIN_LOG ll
					WHERE CREAT_DT BETWEEN STR_TO_DATE(CONCAT(#{searchBgnde},'000000'), '%Y%m%d%H%i%s') AND STR_TO_DATE(CONCAT(#{searchEndde},'235959'), '%Y%m%d%H%i%s')
						AND CONECT_MTHD = 'O'
					GROUP BY CREAT_YEAR, CREAT_MONTH, CREAT_DAY 
				) t2 ON t2.LOGIN_DE = t1.DE
				LEFT JOIN (
					SELECT 
						DATE_FORMAT(m.SBSCRB_DE,'%Y%m%d') SBSCRB_DE
						,COUNT(*) SBSCRB_CNT
					FROM DTN_MBER m
					WHERE m.SBSCRB_DE BETWEEN STR_TO_DATE(CONCAT(#{searchBgnde},'000000'), '%Y%m%d%H%i%s') AND STR_TO_DATE(CONCAT(#{searchEndde},'235959'), '%Y%m%d%H%i%s')
					GROUP BY DATE_FORMAT(m.SBSCRB_DE,'%Y-%m-%d')
				) t3 ON t3.SBSCRB_DE = t1.DE
				LEFT JOIN (
					SELECT 
						SETLE_DE
						,COUNT(GOODS_ID) GOODS_CNT
						,SUM(SETLE_STOT_AMOUNT) SETLE_STOT_AMOUNT
					FROM (
						SELECT 
							DATE_FORMAT(SETLE_PNTTM,'%Y%m%d') SETLE_DE
							,g.GOODS_ID 
							,IF(os.SETLE_STTUS_CODE='S',os.SETLE_TOT_AMOUNT,0) AS SETLE_STOT_AMOUNT
						FROM	STN_ORDER_DLVY od
						JOIN	STN_ORDER_SETLE os ON os.ORDER_SETLE_NO = od.ORDER_SETLE_NO
						JOIN 	STN_ORDER o ON o.ORDER_NO = od.ORDER_NO
						JOIN 	STN_GOODS g ON g.GOODS_ID = o.GOODS_ID

						WHERE 	od.ORDER_REQ_STTUS_CODE IN ('O','C')
							AND os.SETLE_PNTTM  BETWEEN STR_TO_DATE(CONCAT(#{searchBgnde},'000000'), '%Y%m%d%H%i%s') AND STR_TO_DATE(CONCAT(#{searchEndde},'235959'), '%Y%m%d%H%i%s')
					) d 
				) t4 ON t4.SETLE_DE = t1.DE
		) t5
		GROUP BY WD
		ORDER BY WD ASC
	</select>
	
	<!-- 고객 시간별 분석목록 -->
	<select id="selectStatsCstmrHourList" parameterType="modoo.module.shop.stats.cstmr.service.StatsCstmrSearchVO" resultType="egovMap">
		SELECT 
			CONCAT(DE_HOUR, ':00 - ', LPAD(DE_HOUR + 1, 2, 0), ':00') AS DE_HOUR
			,SUM(LOGIN_CNT) LOGIN_CNT
			,SUM(SBSCRB_CNT) SBSCRB_CNT
			,SUM(GOODS_CNT) GOODS_CNT
			,SUM(SETLE_STOT_AMOUNT) SETLE_STOT_AMOUNT
		FROM (
			SELECT 
				DE_HOUR
				,IFNULL(LOGIN_CNT,0) LOGIN_CNT
				,IFNULL(SBSCRB_CNT,0) SBSCRB_CNT
				,IFNULL(t4.GOODS_CNT,0) GOODS_CNT
				,IFNULL(t4.SETLE_STOT_AMOUNT,0) SETLE_STOT_AMOUNT
			FROM (
				SELECT '00' AS DE_HOUR UNION ALL SELECT '01' AS DE_HOUR UNION ALL SELECT '02' AS DE_HOUR UNION ALL SELECT '03' AS DE_HOUR UNION ALL SELECT '04' AS DE_HOUR UNION ALL SELECT '05' AS DE_HOUR UNION ALL
				SELECT '06' AS DE_HOUR UNION ALL SELECT '07' AS DE_HOUR UNION ALL SELECT '08' AS DE_HOUR UNION ALL SELECT '09' AS DE_HOUR UNION ALL SELECT '10' AS DE_HOUR UNION ALL SELECT '11' AS DE_HOUR UNION ALL
				SELECT '12' AS DE_HOUR UNION ALL SELECT '13' AS DE_HOUR UNION ALL SELECT '14' AS DE_HOUR UNION ALL SELECT '15' AS DE_HOUR UNION ALL SELECT '16' AS DE_HOUR UNION ALL SELECT '17' AS DE_HOUR UNION ALL 
				SELECT '18' AS DE_HOUR UNION ALL SELECT '19' AS DE_HOUR UNION ALL SELECT '20' AS DE_HOUR UNION ALL SELECT '21' AS DE_HOUR UNION ALL SELECT '22' AS DE_HOUR UNION ALL SELECT '23' AS DE_HOUR 
			) t1 
			LEFT JOIN (
				 SELECT 
					DATE_FORMAT(ll.CREAT_DT, '%H') LOGIN_HOUR
					,COUNT(*) LOGIN_CNT
				FROM DTH_LOGIN_LOG ll
				WHERE CREAT_DT BETWEEN STR_TO_DATE(CONCAT(#{searchBgnde},'000000'), '%Y%m%d%H%i%s') AND STR_TO_DATE(CONCAT(#{searchEndde},'235959'), '%Y%m%d%H%i%s')
					AND CONECT_MTHD = 'O'
				GROUP BY CREAT_YEAR, CREAT_MONTH, CREAT_DAY 
			) t2 ON t2.LOGIN_HOUR = t1.DE_HOUR
			LEFT JOIN (
				SELECT 
					DATE_FORMAT(m.SBSCRB_DE,'%H') SBSCRB_HOUR
					,COUNT(*) SBSCRB_CNT
				FROM DTN_MBER m
				WHERE m.SBSCRB_DE BETWEEN STR_TO_DATE(CONCAT(#{searchBgnde},'000000'), '%Y%m%d%H%i%s') AND STR_TO_DATE(CONCAT(#{searchEndde},'235959'), '%Y%m%d%H%i%s')
				GROUP BY DATE_FORMAT(m.SBSCRB_DE,'%Y-%m-%d')
			) t3 ON t3.SBSCRB_HOUR = t1.DE_HOUR
			LEFT JOIN (
				SELECT 
					SETLE_HOUR
					,COUNT(GOODS_ID) GOODS_CNT
					,SUM(SETLE_STOT_AMOUNT) SETLE_STOT_AMOUNT
				FROM (
					SELECT 
						DATE_FORMAT(SETLE_PNTTM,'%H') SETLE_HOUR
						,g.GOODS_ID 
						,IF(os.SETLE_STTUS_CODE='S',os.SETLE_TOT_AMOUNT,0) AS SETLE_STOT_AMOUNT
					FROM	STN_ORDER_DLVY od
					JOIN	STN_ORDER_SETLE os ON os.ORDER_SETLE_NO = od.ORDER_SETLE_NO
					JOIN 	STN_ORDER o ON o.ORDER_NO = od.ORDER_NO
					JOIN 	STN_GOODS g ON g.GOODS_ID = o.GOODS_ID

					WHERE 	od.ORDER_REQ_STTUS_CODE IN ('O','C')
						AND os.SETLE_PNTTM  BETWEEN STR_TO_DATE(CONCAT(#{searchBgnde},'000000'), '%Y%m%d%H%i%s') AND STR_TO_DATE(CONCAT(#{searchEndde},'235959'), '%Y%m%d%H%i%s')
				) d 
			) t4 ON t4.SETLE_HOUR = t1.DE_HOUR
		) t5
		GROUP BY DE_HOUR
	</select>
	
	<!-- 배송지역별 분석 목록 -->
	<select id="selectStatsCstmrAreaList" parameterType="modoo.module.shop.stats.cstmr.service.StatsCstmrSearchVO" resultType="egovMap">
		SELECT
			AREA_NM
			,SUM(ORDER_CNT) ORDER_CNT
			,SUM(GOODS_CNT) GOODS_CNT
			,SUM(SETLE_STOT_AMOUNT) SETLE_STOT_AMOUNT
		FROM (
				SELECT 
					CASE WHEN DLVY_ZIP BETWEEN '01' AND '09' THEN '서울'
						WHEN DLVY_ZIP BETWEEN '10' AND '20' THEN '경기'
						WHEN DLVY_ZIP BETWEEN '21' AND '23' THEN '인천'
						WHEN DLVY_ZIP BETWEEN '24' AND '26' THEN '강원'
						WHEN DLVY_ZIP BETWEEN '27' AND '29' THEN '충복'
						WHEN DLVY_ZIP = '30' THEN '세종'
						WHEN DLVY_ZIP BETWEEN '31' AND '33' THEN '충남'
						WHEN DLVY_ZIP BETWEEN '34' AND '35' THEN '대전'
						WHEN DLVY_ZIP BETWEEN '36' AND '40' THEN '경북'
						WHEN DLVY_ZIP BETWEEN '41' AND '43' THEN '대구'
						WHEN DLVY_ZIP BETWEEN '44' AND '45' THEN '울산'
						WHEN DLVY_ZIP BETWEEN '46' AND '49' THEN '부산'
						WHEN DLVY_ZIP BETWEEN '50' AND '53' THEN '경남'
						WHEN DLVY_ZIP BETWEEN '54' AND '56' THEN '전북'
						WHEN DLVY_ZIP BETWEEN '57' AND '60' THEN '전남'
						WHEN DLVY_ZIP BETWEEN '61' AND '62' THEN '광주'
						WHEN DLVY_ZIP = '63' THEN '제주'
						ELSE '기타'
						END AREA_NM
					,SUM(ORDER_CNT) ORDER_CNT 
					,COUNT(GOODS_ID) GOODS_CNT
					,SUM(SETLE_STOT_AMOUNT) SETLE_STOT_AMOUNT
				FROM (
				
						SELECT 
							SUBSTR(od.DLVY_ZIP,1,2) DLVY_ZIP 
							,1 AS ORDER_CNT
							,g.GOODS_ID
							,IF(os.SETLE_STTUS_CODE='S',os.SETLE_TOT_AMOUNT,0) AS SETLE_STOT_AMOUNT
						FROM	STN_ORDER_DLVY od
						JOIN	STN_ORDER_SETLE os ON os.ORDER_SETLE_NO = od.ORDER_SETLE_NO
						JOIN 	STN_ORDER o ON o.ORDER_NO = od.ORDER_NO
						JOIN 	STN_GOODS g ON g.GOODS_ID = o.GOODS_ID

						WHERE 	od.ORDER_REQ_STTUS_CODE IN ('O','C')
							AND os.SETLE_PNTTM  BETWEEN STR_TO_DATE(CONCAT(#{searchBgnde},'000000'), '%Y%m%d%H%i%s') AND STR_TO_DATE(CONCAT(#{searchEndde},'235959'), '%Y%m%d%H%i%s')
				
				) d
				GROUP BY DLVY_ZIP
		) e
		GROUP BY AREA_NM
	</select>
	
	<!-- Ez 포인트 사용분석 목록 -->
	<select id="selectStatsCstmrEzpointList" parameterType="modoo.module.shop.stats.cstmr.service.StatsCstmrSearchVO" resultType="egovMap">
		SELECT 
			DE
			,IFNULL(SETLE_STOT_AMOUNT,0) SETLE_STOT_AMOUNT
			,IFNULL(SETLE_POINT,0) SETLE_POINT
		FROM (
			SELECT
				DATE_FORMAT(GEN_DATE, '%Y-%m-%d') DE
			FROM (SELECT ADDDATE('1970-01-01',T4*10000 + T3*1000 + T2*100 + T1*10 + T0) GEN_DATE FROM
							 (SELECT 0 T0 UNION SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5 UNION SELECT 6 UNION SELECT 7 UNION SELECT 8 UNION SELECT 9) T0,
							 (SELECT 0 T1 UNION SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5 UNION SELECT 6 UNION SELECT 7 UNION SELECT 8 UNION SELECT 9) T1,
							 (SELECT 0 T2 UNION SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5 UNION SELECT 6 UNION SELECT 7 UNION SELECT 8 UNION SELECT 9) T2,
							 (SELECT 0 T3 UNION SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5 UNION SELECT 6 UNION SELECT 7 UNION SELECT 8 UNION SELECT 9) T3,
							 (SELECT 0 T4 UNION SELECT 1 UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5 UNION SELECT 6 UNION SELECT 7 UNION SELECT 8 UNION SELECT 9) T4
			) V
			WHERE GEN_DATE BETWEEN STR_TO_DATE(CONCAT(#{searchBgnde},'000000'), '%Y%m%d%H%i%s') AND STR_TO_DATE(CONCAT(#{searchEndde},'235959'), '%Y%m%d%H%i%s')
		) t1 LEFT JOIN (
			SELECT 
				DATE_FORMAT(os.SETLE_PNTTM, '%Y-%m-%d') SETLE_DE
				,SUM(IF(os.SETLE_STTUS_CODE='S',os.SETLE_TOT_AMOUNT,0)) AS SETLE_STOT_AMOUNT
				,SUM(IFNULL(os.SETLE_POINT, 0)) SETLE_POINT
			FROM	STN_ORDER_DLVY od
			JOIN	STN_ORDER_SETLE os ON os.ORDER_SETLE_NO = od.ORDER_SETLE_NO
			JOIN 	STN_ORDER o ON o.ORDER_NO = od.ORDER_NO
			JOIN 	STN_GOODS g ON g.GOODS_ID = o.GOODS_ID

			WHERE 	od.ORDER_REQ_STTUS_CODE IN ('O','C')
				AND os.SETLE_PNTTM  BETWEEN STR_TO_DATE(CONCAT(#{searchBgnde},'000000'), '%Y%m%d%H%i%s') AND STR_TO_DATE(CONCAT(#{searchEndde},'235959'), '%Y%m%d%H%i%s')
			GROUP BY DATE_FORMAT(os.SETLE_PNTTM, '%Y-%m-%d') 
		) t2 ON t2.SETLE_DE = t1.DE
	</select>
	
</mapper>